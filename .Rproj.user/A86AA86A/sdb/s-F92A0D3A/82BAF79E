{
    "collab_server" : "",
    "contents" : "# Organize data\n\nlibrary(httr)\nset_config(config(ssl_verifypeer = 0L))\n\nlibrary(tidyverse)\nlibrary(rvest)\nlibrary(stringr)\nlibrary(lubridate)\n\n\nbase_url <- 'https://www.rita.dot.gov/bts/sites/rita.dot.gov.bts/files/subject_areas/airline_information/passengers_denied_confirmed_space_report/'\n\nall_data <- data.frame()\n\ncol_names <- c(\"CARRIER\", \"1(a)\", \"1(b)\", \"2(a)\", \"2(b)\", \"2(c)\", \"3\", \"4\", \"5\", \n               \"6(a)\", \"6(b)\", \"7\", \"8(a)\", \"8(b)\", \"8(c)\")\n\nfor (year in 2008:2010){\n  for (q in 1:4){\n    data <- read_csv(paste0(base_url, year, '/csv/', year, '_', q, 'q.csv'), skip = 3, col_names = col_names)\n    data$release <- paste0(year, \"_q\", q)\n    all_data <- rbind(all_data, data)\n  }\n}\n\n# Add Q1 2011\ndata_2011 <- read_csv(\"https://www.rita.dot.gov/bts/sites/rita.dot.gov.bts/files/subject_areas/airline_information/passengers_denied_confirmed_space_report/2011/csv/2011_1q.csv\", skip = 3, col_names = col_names)\ndata_2011$release <- \"2011_q1\"\nall_data <- rbind(all_data, data_2011)\n\n#### New base url\nbase_url <- 'http://www.rita.dot.gov/bts/sites/rita.dot.gov.bts/files/'\n\nfor (year in 2012:2015){\n  for (q in 1:4){\n    data <- read_csv(paste0(base_url, year, '_', q, 'q.csv'), skip = 3, col_names = col_names)\n    data$release <- paste0(year, \"_q\", q)\n    all_data <- rbind(all_data, data)\n  }\n}\n\nmiscell_quarters <- c(\"2011_2q\", \"2011_3q\", \"2011_4q\", \n                      \"2016_1q\")\n\nfor (m_q in miscell_quarters) {\n  data <- read_csv(paste0(base_url, m_q, \".csv\"), skip = 3, col_names =  col_names)\n  data$release <- m_q\n  all_data <- rbind(all_data, data)\n}\n\n\n## Filter out footnotes\nclean_data <- all_data %>% \n  filter(is.na(as.numeric(substr(CARRIER, 1, 1)))) %>% \n  rename(carrier = CARRIER, \n         pass_trans = `1(a)`,\n         pass_no_trans = `1(b)`,\n         no_comp_new_flight = `2(a)`,\n         no_comp_small_equip = `2(b)`,\n         no_comp_fail_comply = `2(c)`,\n         denied_boarding = `3`,\n         receive_comp = `4`,\n         volunteer_for_pay = `5`,\n         upgrades = `6(a)`,\n         downgrades = `6(b)`,\n         total_boardings = `7`,\n         comp_alt_trans = `8(a)`,\n         comp_no_trans = `8(b)`,\n         comp_volunteers = `8(c)`) \n\n# TODO\n# Dedupe carrier names\n# Remove , and $ charactersx\n                      \nclean_data2 <- clean_data %>% \n  mutate(carrier = str_trim(str_replace(str_replace(str_replace(carrier, \"Air Lines\", \"\"), \"Airlines\", \"\"), \"Airways\", \"\"))) %>% \n  mutate(carrier = ifelse(carrier == \"Air Tran\", \"AirTran\", carrier),\n         carrier = ifelse(carrier == \"SkyWest\", \"Skywest\", carrier),\n         carrier = ifelse(carrier == \"Virgin America\", \"Virgin\", carrier)) %>% \n  filter(!is.na(carrier)) %>% \n  gather(var, data, -c(carrier, release)) %>% \n  mutate(data = gsub(\",\", \"\", gsub(\"\\\\$\", \"\", data)),\n         data = ifelse(data == \"n/a\", NA, data),\n         data = as.numeric(data)) %>% \n  spread(var, data) %>% \n  separate(release, into = c(\"year\", \"quarter\")) %>% \n  mutate(quarter = ifelse(quarter %in% c(\"q1\", \"1q\"), \"1/1/\", \n                          ifelse(quarter %in% c(\"q2\", \"2q\"), \"4/1/\",\n                                 ifelse(quarter %in% c(\"q3\", \"3q\"), \"7/1/\", \n                                        ifelse(quarter %in% c(\"q4\", \"4q\"), \"10/1/\", quarter))))) %>% \n  mutate(date = mdy(paste0(quarter, year))) %>% \n  select(carrier, date, 4:17) %>% \n  mutate(year = year(date),\n         involuntary_db_per_10k = denied_boarding / (total_boardings/10000),\n         voluntary_db_per_10k = volunteer_for_pay / (total_boardings/10000))\n\n############### Summary statistics ###############\n\n# currently operating airlines\ncurrent_carriers <- clean_data2 %>% \n  filter(date == \"2016-01-01\") %>% \n  select(carrier) %>% \n  unlist() %>% \n  as.character()\n\n# involuntary DBs over time\nclean_data2 %>%\n  filter(carrier %in% current_carriers) %>% \n  ggplot(aes(x = date, group = carrier, color = carrier)) + \n  geom_line(aes(y = involuntary_db_per_10k)) \n\n# voluntary DBs over time\nclean_data2 %>%\n  filter(carrier %in% current_carriers) %>% \n  ggplot(aes(x = date, group = carrier, color = carrier)) + \n  geom_line(aes(y = voluntary_db_per_10k)) \n\n# avg boardings per quarter\nclean_data2 %>% \n  group_by(carrier) %>% \n  summarize(avg_boarding = mean(total_boardings)) %>% \n  arrange(desc(avg_boarding))\n\n# overall IDB rate\n\n\noverall_db_rates <- clean_data2 %>% \n  filter(carrier %in% current_carriers) %>% \n  group_by(carrier) %>% \n  summarize(total_boardings = sum(total_boardings),\n            involuntary_db = sum(denied_boarding),\n            voluntary_db = sum(volunteer_for_pay),\n            involuntary_db_per_10k = involuntary_db / (total_boardings/10000),\n            voluntary_db_per_10k = voluntary_db / (total_boardings/10000)\n            ) %>% \n  arrange(desc(involuntary_db_per_10k))\n\n# compensation \nggplot(clean_data2, aes(x = receive_comp, y = comp_no_trans)) + \n  geom_point() + ggtitle(\"Compensation for involuntary denied boarding\")\n  \nggplot(clean_data2, aes(x = volunteer_for_pay, y = comp_volunteers)) + \n  geom_point() + ggtitle(\"Compensation for voluntary denied boarding\")\n\n# yearly aggregates\nclean_data2 %>% \n  mutate(year = year(date)) %>% \n  group_by(year) %>% \n  summarize(total_boardings = sum(total_boardings),\n            involuntary_db = sum(denied_boarding),\n            voluntary_db = sum(volunteer_for_pay),\n            involuntary_db_per_10k = involuntary_db / (total_boardings/10000),\n            voluntary_db_per_10k = voluntary_db / (total_boardings/10000)\n            ) %>% View\n  \n# yearly aggregates by carrier\ncarrier_by_year <- clean_data2 %>% \n  # filter(carrier %in% current_carriers) %>% \n  mutate(year = year(date)) %>% \n  group_by(carrier, year) %>% \n  summarize(total_boardings = sum(total_boardings),\n            involuntary_db = sum(denied_boarding),\n            voluntary_db = sum(volunteer_for_pay),\n            involuntary_db_per_10k = involuntary_db / (total_boardings/10000),\n            voluntary_db_per_10k = voluntary_db / (total_boardings/10000)\n  )\n\nby_year <- carrier_by_year %>% \n  group_by(year) %>% \n  summarize(\n            avg_involuntary_db_per_10k = mean(involuntary_db_per_10k),\n            voluntary_db_per_10k = mean(voluntary_db_per_10k)\n  )\n  \n\ninvol_chart <- carrier_by_year %>% \n  ggplot(aes(x = year, group = carrier, color = carrier)) +\n  geom_line(aes( y = involuntary_db_per_10k)) + \n  xlab(\"Year\") + ylab(\"Per 10,000 passenergers\") + \n  ggtitle(\"Involuntary denial of boarding by airline\")\n\ninvol_chart\nggsave(filename = \"invol_chart.png\", plot = invol_chart)\n\nvol_chart <- carrier_by_year %>% \n  ggplot(aes(x = year, group = carrier, color = carrier)) +\n  geom_line(aes( y = voluntary_db_per_10k)) + \n  xlab(\"Year\") + ylab(\"Per 10,000 passenergers\") + \n  ggtitle(\"Voluntary denial of boarding by airline\")\n\nvol_chart\nggsave(filename = \"vol_chart.png\", plot = vol_chart)\n\noptions(signif=2)\n\ngraph_data <- overall_db_rates %>% \n  select(1, 5, 6) %>%\n  mutate(involuntary_db_per_10k = round(involuntary_db_per_10k, digits = 2),\n         voluntary_db_per_10k = round(voluntary_db_per_10k, digits = 2)) %>% \n  rename(Carrier = carrier,\n         `Involuntary DB rate` = involuntary_db_per_10k,\n         `Voluntary DB rate` = voluntary_db_per_10k) \n\n# IDB scatter\ngraph_data %>% \n  ggplot(aes(x = `Involuntary DB rate`, y = `Voluntary DB rate`, label = Carrier)) +\n  geom_point() + geom_text(hjust = 0.4) + \n  ggtitle(\"U.S. Airline Voluntary and Involuntary Denial of Boarding \\nPer 10,000 passengers, 2008-2016 average\")\n\n## United and average DB rates over time\nunited_comp <- carrier_by_year %>% \n  filter(carrier == \"United\") %>% \n  left_join(by_year, by = \"year\") %>% \n  select(1, 2, 6, 7, 11, 12)\n\nunited_comp %>% \n  ggplot(aes(x = year)) + \n  geom_line(aes(y = involuntary_db_per_10k.x)) +\n  geom_line(aes(y = involuntary_db_per_10k.y)) +\n  geom_line(aes(y = voluntary_db_per_10k.x)) +\n  geom_line(aes(y = voluntary_db_per_10k.y))\n  \n         \n         \n",
    "created" : 1488564875204.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2327976870",
    "id" : "82BAF79E",
    "lastKnownWriteTime" : 1491888553,
    "last_content_update" : 1491888553922,
    "path" : "~/projects/bumped-flights/data.R",
    "project_path" : "data.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}